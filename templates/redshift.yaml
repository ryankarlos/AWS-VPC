Description: "This template creates a child stack with redshift resource with enhanced VPC routing in a custom vpc"
Parameters:
  Username:
    Description: "Redshift Master username"
    Type: "String"
  Password:
    Description: "Redshift Master password"
    Type: "String"
  Subnet1:
    Default: subnet-0559a76c20973f935
    Description: "Default VPC Public Subnet 1 ind for redshift subnet group"
    Type: "String"
  Subnet2:
    Default: subnet-0bca7c8227c55bf1f
    Description: "Default VPC Public subnet 2 for redshift subnet group"
    Type: "String"
  Subnet3:
    Default: subnet-0ec7aae8fc47315b5
    Description: "Default VPC Public subnet 3 for redshift subnet group"
    Type: "String"
  EnhancedRouting:
    Default: true
    Description: "n option that specifies whether to create the cluster with enhanced VPC routing enabled."
    Type: "String"
    AllowedValues:
        - true
        - false
  NodeType:
    Description: "Type of node in redshift cluster. Only allow nodes whose pricing < $1/hr in US-east region"
    Default: dc2.large
    AllowedValues:
      - ds2.xlarge
      - dc1.large
      - dc2.large
    Type: "String"
  DBName:
    Description: "Name of redshift db"
    Default: dev
    Type: "String"
  EC2SecurityGroup1:
      Default: "sg-0afdf2d5ce4c8ed3e"
      Description: The id of EC2 security group id attached to default VPC
      Type: String
      AllowedPattern: 'sg-[a-zA-Z0-9]*'
      ConstraintDescription: must begin with sg- and contain alphanumeric characters
  EC2SecurityGroup2:
      Description: The id of EC2 security group id attached to non-default VPC
      Type: String
      AllowedPattern: 'sg-[a-zA-Z0-9]*'
      ConstraintDescription: must begin with sg- and contain alphanumeric characters
  VPC:
      Default: "vpc-09eeb45f883f8307c"
      Description: "Default VPC ID"
      Type: "String"
  ClientIP:
      AllowedPattern: "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})"
      ConstraintDescription: "It must be a valid IP CIDR range of the form x.x.x.x/x. Suggest to enable access to your IP address only. Pls get your address using checkip.amazonaws.com or whatsmyip.org."
      Description: "The IP address range that can be used to connect to the RDS instances from your local machine.It must be a valid IP CIDR range of the form x.x.x.x/x.Pls get your address using checkip.amazonaws.com or whatsmyip.org"
      Type: "String"
Resources:
  RedshiftCluster:
    Type: "AWS::Redshift::Cluster"
    Properties:
      DBName:
        Ref: "DBName"
      MasterUsername:
        Ref: "Username"
      MasterUserPassword:
        Ref: "Password"
      NodeType:
        Ref: "NodeType"
      ClusterType: "single-node"
      ClusterIdentifier: "default-cluster"
      Port: "8192"
      ClusterSecurityGroups: [!Ref "RedshiftSecurityGroup"]
      ClusterParameterGroupName:
        Ref: "RedshiftClusterParameterGroup"
      ClusterSubnetGroupName:
        Ref: "RedshiftSubnetGroup"
      EnhancedVpcRouting:
          Ref: "EnhancedRouting"
  RedshiftClusterParameterGroup:
      Properties:
          Description: "Cluster parameter group"
          ParameterGroupFamily: "redshift-1.0"
          Parameters:
              - { ParameterName: "enable_user_activity_logging", ParameterValue: "true" }
      Type: "AWS::Redshift::ClusterParameterGroup"
  RedshiftSubnetGroup:
      Type: "AWS::Redshift::ClusterSubnetGroup"
      Properties:
          Description: "Default VPC Public Subnet Group available for the default Redshift Cluster"
          SubnetIds: [!Ref Subnet1, !Ref Subnet2, !Ref Subnet3]
  RedshiftSecurityGroup:
      Type: AWS::EC2::SecurityGroup
      Properties:
          GroupDescription: "Redshift for non-default VPC"
          VpcId: !Ref VPC
          SecurityGroupIngress:
              -   IpProtocol: tcp
                  FromPort: 5439
                  ToPort: 5432
                  CidrIp: !Ref ClientIP
              -   IpProtocol: tcp
                  FromPort: 0
                  ToPort: 65535
                  SourceSecurityGroupId:
                      Ref: "EC2SecurityGroup1"
              -   IpProtocol: tcp
                  FromPort: 0
                  ToPort: 65535
                  SourceSecurityGroupId:
                      Ref: "EC2SecurityGroup2"
          SecurityGroupEgress:
              -   CidrIp: "0.0.0.0/0"
                  IpProtocol: "-1"
          Tags:
              -   Key: Name
                  Value: Redshift
